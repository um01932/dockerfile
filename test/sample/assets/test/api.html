<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>API TEST</title>
    <script type="text/javascript" src="/workplace-api/es6-promise.js"></script>
    <script type="text/javascript" src="/workplace-api/workplace-api.js"></script>
</head>
<body>
  <textarea id="mirror" cols="100" rows="20" onchange="callApiMirror(this.value)" placeholder="Type text which will be tranfered to mirror"></textarea>
  <!-- input type="text" onchange="checkApp(this.value)" / -->
  <br>Params passed to the application:
  <pre id="params"></pre>
  <script>

      // workplace is setting url parameter env=workplace
      var client;

      if(Messaging.isWorkplaceEnv()) {

          var paramsEl = document.getElementById('params');
          Messaging.getClient().then(function(client) {
            client.registerApi('refresh', function (params) {
              paramsEl.innerHTML = JSON.stringify(params, null, 2);
            });
          });

          // Connect to app "mirror" and
          var mirrorConnection;

          function callApiMirror(text) {
              Messaging.getClient().then(function(client) {
                if (!mirrorConnection) {
                  client.callApi('openApp', 'mirror').then(function (id) {
                    client.callApi('connect', {id: id}).then(function (connection) {
                      mirrorConnection = connection;
                      mirrorConnection.onClose(function () {
                        mirrorConnection = null;
                      });
                      //Register an api function at the connection to mirror, so that mirror can call the function
                      mirrorConnection.registerApi('pingBack', function(message) {
                        console.log('api.html -> pingBack from mirror: ' + message);
                      });
                      mirrorConnection.onClose(function() {
                          console.log('api.html -> connection to mirror has been closed');
                      })
                      callApiMirror(text);
                    });
                  });
                } else {
                  mirrorConnection.callApi('mirrorText', [text]);
                }
              });
          }

          function checkApp(value) {
            Messaging.getClient().then(function(client) {
              client.callApi('isAppAvailable', value).then(function(available) {
                console.log('api -> checkApp', available);
              });
            });

          }

          function openAppWithCallback() {
            Messaging.getClient().then(function(client) {
              client.callApi('openAppWithCallback', 'mirror', 'ping').then(function (result) {
                console.log('received from mirror:', result);
              });
            });
          }

      }

  </script>
</body>
</html>
