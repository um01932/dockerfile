<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <title>API TEST</title>
  <script type="text/javascript" src="/workplace-api/es6-promise.js"></script>
  <script type="text/javascript" src="/workplace-api/workplace-api.js"></script>
  <style>
    #popup .mask {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.3);
    }

    #popup .body {
      position: fixed;
      width: 300px;
      height: 100px;
      top: 50%;
      margin-top: -50px;
      left: 50%;
      margin-left: -100px;
      text-align: center;
      background-color: white;
      box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>
<body>
<div id="isAppAvailable">
  <h3>isAppAvailable</h3>
  <input placeholder="app name, z.B. tlt" type="text"/>
  <button onclick="isAppAvailable()">Check</button>
</div>

<div id="openUrl">
  <h3>openUrl</h3>
  <input placeholder="url" type="text"/>

  <br><br>
  <input type="radio" id="openNewWorkplaceTab" name="openUrl" value="W" checked>
  <label for="openNewWorkplaceTab">Open in new workplace tab</label>

  <br><br>
  <input type="radio" id="openNewBrowserTab" name="openUrl" value="B">
  <label for="openNewBrowserTab">Open in new browser tab</label>

  <br><br>
  <input type="radio" id="openNewWindow" name="openUrl" value="N">
  <label for="openNewWindow">Open in new browser window</label>

  <br><br>
  <button onclick="openUrl()">Open url</button>
</div>

<div id="openApp">
  <h3>openApp</h3>
  <input placeholder="app name, z.B. tlt" type="text"/> <label><input type="checkbox"/>Split View</label>
  <button onclick="openApp()">Open</button>
</div>
<div id="openAppConfig">
  <h3>openApp (config)</h3>
  <table border="1">
    <thead>
    <tr>
      <th>Property</th>
      <th>Description</th>
    </tr>
    </thead>
    <tbody>
    <tr>
      <td>name:string</td>
      <td>Required. Name of the application</td>
    </tr>
    <tr>
      <td>path:string</td>
      <td>Optional. Relative path appended to app origin</td>
    </tr>
    <tr>
      <td>queryParams:Object</td>
      <td>Query parameter object</td>
    </tr>
    <tr>
      <td>hash:string</td>
      <td>URL fragment string</td>
    </tr>
    <tr>
      <td>tabTitle:string</td>
      <td>Optional. A custom title for the opened app's workplace tab.</td>
    </tr>
    <tr>
      <td>options.splitView:boolean</td>
      <td>Optional. Will display the opened app in a split view. If the workplace is already in split view, app will be opened in the opposite tab manager of the calling app.</td>
    </tr>
    <tr>
      <td>options.modal:boolean</td>
      <td>Optional. Will open the app in a modal window. Cannot be combined with splitView option.</td>
    </tr>
    </tbody>
  </table>
  <br><textarea cols="80" rows="10">
    {
      "name": "api",
      "path": "",
      "queryParams": {"param1":"value1"},
      "hash": "url-fragment-without-hash",
      "tabTitle": "My custom tab title",
      "options": {
        "splitView": false,
        "modal": false
      }
    }
  </textarea>
  <br><span class="error" style="display:none; color: red">Invalid json!</span>
  <br>
  <button onclick="openAppConfig()">Open</button>
</div>
<div id="businessObjectsApps">
  <h3>businessObjectsApps</h3>
  <input placeholder="bo type: nael, mygams" type="text" id="boType"/>
  <input placeholder="bo id: AY..., mygams" type="text" id="boId"/>
  <button onclick="getAppLinksForBO()">Get app links</button>
</div>
<div id="createTask">
  <h3>createTask</h3>
  <input placeholder="task title" width="150px" type="text" id="taskTitle"/><br>
  <input placeholder="optional: bo type: nael, mygams" type="text" width="150px" id="tboType"/><br>
  <input placeholder="optional: bo id: AY..., mygams" type="text" width="150px" id="tboId"/><br>
  <button onclick="createTask()">Create task</button>
</div>
<div id="selectTab">
  <h3>selectTab</h3>
  <p>ID returned by openApp.</p>
  <input placeholder="app id" type="text"/>
  <button onclick="selectTab()">Select</button>
</div>
<div id="closeTab">
  <h3>closeTab</h3>
  <p>ID returned by openApp.</p>
  <input placeholder="app id" type="text"/>
  <button onclick="closeTab()">Close</button>
</div>
<div id="getTabId">
  <h3>getTabId</h3>
  <button onclick="getTabId()">Get Tab ID</button>
</div>
<div id="getTabInfo">
  <h3>getTabInfo</h3>
  <input placeholder="tab id" type="text"/>
  <button onclick="getTabInfo()">Get Tab Info</button>
</div>
<div id="showNotification">
  <h3>showNotification</h3>
  <select>
    <option value="success">success</option>
    <option value="info">info</option>
    <option value="warning">warning</option>
    <option value="error">error</option>
    <option value="N/A">[non existent type]</option>
  </select>
  <input placeholder="text" type="text"/>
  <button onclick="showNotification()">Notify</button>
</div>
<div id="showAppSupport">
  <h3>showAppSupport</h3>
  <table border="1">
    <thead>
    <tr>
      <th>Property</th>
      <th>Description</th>
    </tr>
    </thead>
    <tbody>
    <tr>
      <td>msgCode:string</td>
      <td>Required. Unique error code of the application</td>
    </tr>
    <tr>
      <td>msgType:string</td>
      <td>Possible values: error, warn, info</td>
    </tr>
    <tr>
      <td>category:string</td>
      <td>Possible values: business, technical</td>
    </tr>
    <tr>
      <td>msgText:string</td>
      <td>Error text of the application</td>
    </tr>
    <tr>
      <td>appRole:string</td>
      <td>Application role</td>
    </tr>
    <tr>
      <td>appState:string</td>
      <td>Description of current application state</td>
    </tr>
    <tr>
      <td>serviceGroup:string</td>
      <td>The support service group id</td>
    </tr>
    </tbody>
  </table>
  <br><textarea cols="80" rows="10">
    {
      "msgCode": "PERR104",
      "msgType": "error",
      "category": "business",
      "msgText": "No permission",
      "appRole": "Checker",
      "appState": "Check UI - Tab Feature 1",
      "serviceGroup": "application:id:service:group"
    }
  </textarea>
  <br><span class="error" style="display:none; color: red">Invalid json!</span>
  <br>
  <button onclick="showAppSupport()">Show</button>
</div>
<div id="createFavorite">
  <h3>createFavorite</h3>
  <p>Backend required! On a local workplace the favorite will not be created.</p>
  <input class="title" placeholder="Title" type="text"/>
  <br><input class="url" placeholder="URL" type="text"/>
  <br><input class="iconCls" placeholder="Icon class" type="text"/>
  <br><input class="bgImage" placeholder="Background image url" type="text"/>
  <br><input class="rowSpan" placeholder="RowSpan" type="text"/>
  <br><input class="colSpan" placeholder="ColSpan" type="text"/>
  <br><input class="type" placeholder="type" type="text"/> <span>Type must be either left blank, or it should say 'favorite' or 'search-favorite'</span>
  <br>
  <button onclick="createFavorite()">Create Favorite</button>
</div>
<div id="refreshSettings">
  <h3>refreshSettings</h3>
  <button onclick="refreshSettings()">refresh</button>
</div>
<div id="sessionExpired">
  <h3>Session Expired</h3>
  <button onclick="sessionExpired()">Pretend session has expired</button>
</div>
<div id="openLayout">
  <h3>Open layout</h3>
  <textarea cols="80" rows="10">
    {
      "id": "layoutId",
      "context": {},
      "widgetContext": {},
      "connectIds": []
    }
  </textarea>
  <br><span class="error" style="display:none; color: red">Invalid json!</span>
  <button onclick="openLayout()">Open layout</button>
</div>
<div id="openDashboard">
  <h3>Open dashboard</h3>
  <textarea cols="80" rows="10">
    {
      "id": "dashboardId",
      "context": {},
      "connectIds": []
    }
  </textarea>
  <br><span class="error" style="display:none; color: red">Invalid json!</span>
  <button onclick="openDashboard()">Open dashboard</button>
</div>

<div id="popup">
  <div class="mask"></div>
  <div class="body">
    <p></p>
    <button id="popupOk">Leave</button>
    <button id="popupCancel">Stay</button>
  </div>
</div>

<script>


    //implement unload handler, for when the iframe/tab containing the app is closed
    window.addEventListener('unload', function (event) {
        console.log('do closing cleanup for apps iframe');
    });

    Messaging.hostWindow = window.opener || window.parent;

    Messaging.getClient().then(function (client) {
        client.registerApi('beforeClose', function (myTabId) {
            console.log('API Event callback "beforeClose"', myTabId);
            // We return a promise, so workplace will wait until it is resolved.
            return new Promise(function (resolve, reject) {
                showPopup(true, 'Tab "' + myTabId + '" is about to be closed! Continue?');
                document.getElementById('popupCancel').addEventListener('click', function () {
                    // User canceled! Return false.
                    resolve(false);
                    showPopup(false);
                });
                document.getElementById('popupOk').addEventListener('click', function () {
                    // Return true
                    resolve(true);
                });
            });
        });
        client.registerApi('roleChanged', function (role, persondeputized) {
            console.log('API Event callback "roleChanged"', role, persondeputized);
        });
        client.registerApi('refresh', function () {
            console.log("API event refresh has been called");
        });
    });

    function openUrl() {
        var url = document.getElementById('openUrl').querySelector('input').value;
        var startMode = document.getElementById('openUrl').querySelector('input[type=radio]:checked').value;
        Messaging.getClient().then(function (client) {
            client.callApi('openHelpUrl', {
                url: url,
                startMode: startMode
            }).then(function (id) {
                console.log('API function "openUrl" succeeded. ' + id);
            }).catch(function (reason) {
                console.log('API function "openUrl" failed. Reason: ' + reason.message);
            });
        });
    }

    function openApp() {
        var appName = document.getElementById('openApp').querySelector('input[type=text]').value;
        var split = document.getElementById('openApp').querySelector('input[type=checkbox]').checked;
        Messaging.getClient().then(function (client) {
            client.callApi('openApp', appName, null, {splitView: split}).then(function (id) {
                console.log('API function "openApp" succeeded. App ID is: ' + id);
            }).catch(function (reason) {
                console.log('API function "openApp" failed. Reason: ' + reason.message);
            });
        });
    }

    function openAppConfig() {
        var json = document.getElementById('openAppConfig').querySelector('textarea').value;
        var error = document.getElementById('openAppConfig').querySelector('.error');
        error.style.display = 'none';
        var config;
        try {
            config = JSON.parse(json);
        } catch (e) {
            error.style.display = '';
        }
        if (config) {
            Messaging.getClient().then(function (client) {
                client.callApi('openApp', config).then(function (id) {
                    console.log('API function "openApp" succeeded. App ID is: ' + id);
                    client.callApi('connect', {id: id}).then( function(connection) {
                        console.log('Connection established to app ' +  id);
                        connection.registerApi('setResponsible', function(responsible) {
                            console.log('Got responsible from person service : ', responsible);
                        });
                    });
                }).catch(function (reason) {
                    console.log('API function "openApp" failed. Reason: ' + reason.message);
                });
            });
        }
    }

    function getAppLinksForBO() {
        var type = document.getElementById('boType').value;
        var id = document.getElementById('boId').value;
        Messaging.getClient().then(function (client) {
            client.callApi('getAppLinksForBO', type, id).then(function (resp) {
                console.log('got response', resp);
            });
        });
    }

    function createTask() {
        var title = document.getElementById('taskTitle').value;
        var type = document.getElementById('tboType').value;
        var id = document.getElementById('tboId').value;
        Messaging.getClient().then(function (client) {
            client.callApi('createTask', title, type, id).then(function (resp) {
                console.log('Created task successfully');
            }).catch(function() {
                console.log('Could not create task');
            });
        });
    }

    function selectTab() {
        var tabId = document.getElementById('selectTab').querySelector('input').value;
        Messaging.getClient().then(function (client) {
            client.callApi('selectTab', tabId).catch(function (reason) {
                console.log('API function "selectTab" failed. Reason: ' + reason.message);
            });
        });
    }

    function closeTab() {
        var tabId = document.getElementById('closeTab').querySelector('input').value;
        Messaging.getClient().then(function (client) {
            client.callApi('closeTab', tabId).catch(function (reason) {
                console.log('API function "closeTab" failed. Reason: ' + reason.message);
            });
        });
    }

    function isAppAvailable() {
        var appName = document.getElementById('isAppAvailable').querySelector('input').value;
        Messaging.getClient().then(function (client) {
            client.callApi('isAppAvailable', appName).then(function (available) {
                console.log('API function "isAppAvailable" succeeded. App "' + appName + '" is ' + (available ? '' : 'NOT ') + 'available.');
            }).catch(function (reason) {
                console.log('API function "isAppAvailable" failed. Reason: ' + reason.message);
            });
        });

    }

    function showNotification() {
        var text = document.getElementById('showNotification').querySelector('input').value;
        var type = document.getElementById('showNotification').querySelector('select').value;
        Messaging.getClient().then(function (client) {
            client.callApi('showNotification', type, text).catch(function (reason) {
                console.log('API function "showNotification" failed. Reason: ' + reason.message);
            });
        });
    }


    function showAppSupport() {
        var json = document.getElementById('showAppSupport').querySelector('textarea').value;
        var error = document.getElementById('showAppSupport').querySelector('.error');
        error.style.display = 'none';
        var config;
        try {
            config = JSON.parse(json);
        } catch (e) {
            error.style.display = '';
        }
        if (config) {
            Messaging.getClient().then(function (client) {
                client.callApi('showAppSupport', config).catch(function (reason) {
                    console.log('API function "isAppAvailable" failed. Reason: ' + reason.message);
                });
            });
        }
    }

    function createFavorite() {
        var favForm = document.getElementById('createFavorite');
        var title = favForm.querySelector('input.title').value;
        var url = favForm.querySelector('input.url').value;
        var bgImage = favForm.querySelector('input.bgImage').value;
        var iconCls = favForm.querySelector('input.iconCls').value;
        var rowSpan = favForm.querySelector('input.rowSpan').value;
        var colSpan = favForm.querySelector('input.colSpan').value;
        var type = favForm.querySelector('input.type').value;
        Messaging.getClient().then(function (client) {
            client.callApi('createFavorite', {
                title: title,
                url: url,
                backgroundImageUrl: bgImage,
                iconCls: iconCls,
                rowSpan: rowSpan < 1 ? 1 : rowSpan,
                colSpan: colSpan < 1 ? 1 : colSpan,
                type: type
            }).then(function (succeeded) {
                if (succeeded) {
                    console.log('API function "createFavorite" succeeded');
                } else {
                    console.log('API function "createFavorite" was canceled');
                }
            }).catch(function (reason) {
                console.log('API function "createFavorite" failed. Reason: ' + reason.message);
            });
        });
    }

    function getTabId() {
        Messaging.getClient().then(function (client) {
            client.callApi('getTabId').then(function (tabId) {
                client.callApi('showNotification', 'info', 'Tab ID: ' + tabId);
            });
        });
    }


    function refreshSettings() {
        Messaging.getClient().then(function (client) {
            client.callApi('refreshUserSettings');
        })
    }

    function getTabInfo() {
        var tabId = document.getElementById('getTabInfo').querySelector('input').value;
        Messaging.getClient().then(function (client) {
            client.callApi('getTabInfo', tabId).then(function (tabInfo) {
                client.callApi('showNotification', 'info', JSON.stringify(tabInfo));
            });
        });
    }

    function sessionExpired() {
        Messaging.getClient().then(function(client) {
            client.callApi('sessionExpired');
        });
    }

    function openLayout() {
        var json = document.getElementById('openLayout').querySelector('textarea').value;
        var error = document.getElementById('openLayout').querySelector('.error');
        error.style.display = 'none';
        var config;
        try {
            config = JSON.parse(json);
        } catch (e) {
            error.style.display = '';
        }
        if (config) {
            Messaging.getClient().then(function (client) {
                client.callApi('openLayout', config).then(function () {
                    if(config.connectIds) {
                        config.connectIds.forEach(function(widgetId) {
                            client.callApi('connectAll', {id: widgetId}).then(function(connections) {
                                console.log('Connected to "' +  widgetId + '". Number of connections: ' + connections.length);
                            });
                        });
                    }
                }).catch(function(reason) {
                    console.log(reason.message, reason.code);
                });
            });
        }
    }


    function openDashboard() {
        var json = document.getElementById('openDashboard').querySelector('textarea').value;
        var error = document.getElementById('openDashboard').querySelector('.error');
        error.style.display = 'none';
        var config;
        try {
            config = JSON.parse(json);
        } catch (e) {
            error.style.display = '';
        }
        if (config) {
            Messaging.getClient().then(function (client) {
                client.callApi('openDashboard', config).then(function (tabId) {
                    console.log('Tab id: ', tabId);
                    if(config.connectIds) {
                        config.connectIds.forEach(function(widgetId) {
                            client.callApi('connectAll', {id: widgetId}).then(function(connections) {
                                console.log('Connected to "' +  widgetId + '". Number of connections: ' + connections.length);
                            });
                        });
                    }
                }).catch(function(reason) {
                    console.log(reason.message, reason.code);
                });
            });
        }
    }



    var tpl = document.getElementById('popup');
    tpl.parentNode.removeChild(tpl);

    function showPopup(visible, message) {
        if (visible) {
            var p = tpl.cloneNode(true);
            document.body.appendChild(p);
            p.querySelector('p').innerHTML = message;
        } else {
            var p = document.getElementById('popup');
            p.parentNode.removeChild(p);
        }
    }


</script>
</body>
</html>
